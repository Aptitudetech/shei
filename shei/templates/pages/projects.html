{% extends "templates/web.html" %}

{% block title %}{{ doc.project_name }}{% endblock %}

{% block header %}
	<h1>{{ doc.project_name }}</h1>
{% endblock %}

{% block style %}
	<style>
		{% include "erpnext/templates/includes/projects.css" %}
	</style>
	<style>
		.one, .two, .three, .four, .five{
			position:absolute;
			margin-top:-10px;
			z-index:1;
			height:40px;
			width:40px;
			border-radius:25px;
		}
		.one{
			left:0%;
		}
		.two{
			left:20%;
		}
		.three{
			left:40%;
		}
		.four{
			left:60%;
		}
		.five{
			left:80%;
		}
		#project_stage_box {
			border-radius: 10px;
			padding: 20px; 
			width: 200px;
			height: 60px;  
		}
		#project_stage_description {
			border-radius: 25px;
			background-color: white;
			padding: 20px; 
			width: 200px;
			height: 300px; 
			margin-top: -20px;
			margin-left: 40px;
			z-index: 1;
			font-weight: 400;
		}
		#project_stage_label {
			margin-top: -10px; 
			text-align: left; 
			color: white; 
			font-weight: 700;
		}
		* {
		box-sizing: border-box;
		}
		#1address_container {
			background-color: #f89925; 
			opacity: 0.5; 
			width: auto; 
			height: auto;
		}
		#1address_container:hover {
			opacity: 1.0;
		}
	</style>
{% endblock %}

{% block page_content %}
{% set sh_color = "#f89925" %}
{% if doc.percent_complete %}
<div class="progress progress-hg">
	<div class="progress-bar progress-bar-{{ "warning" if doc.percent_complete|round < 100 else "success" }} active"role="progressbar" aria-valuenow="{{ doc.percent_complete|round|int }}"
	aria-valuemin="0" aria-valuemax="100" style="width:{{ doc.percent_complete|round|int }}%;">
	</div>
</div>
{% endif %}	

<!--Get the first unfinished open task for the project-->
{% set curr_project = frappe.get_doc("Project", doc.name) %}
{% set tasks = [] %}
{% for t in curr_project.tasks %}
	{% if t.status != "Closed" %}
		{{ tasks.append(t.title) or ''}}
	{% endif %}
{% endfor %}
{% set first_open_task = (tasks|sort|first) %}

<div class="container">
		<div class="row"><br />
			<div class="col-md-12">
				<div class="progress"  style="width: 84%;">
				<!--display the progress bar based on the project stage-->
					{% set task_number = (first_open_task.split('-')[1]|int) %}
					{% set task_product = first_open_task.split('-')[0] %}
					{% if task_number == 0 %}
						{% set task_stage = _('Deposit') %}
						{% set progress_pourcentage = 0 %}
						{% set progress_color = '#5cb85c' %}
						{% set project_stage_description = _("Waiting on message... <br><br><br> 1-3 days") %}
					{% elif task_number <= 2 %}
						{% set task_stage = _('Preflight') %}
						{% set progress_pourcentage = 25 %}
						{% set progress_color = '#E78037' %}
						{% set project_stage_description = _("We examine your files and make sure they are print ready. Please make sure your files are done according to our graphic preparation guide to avoid delays <br><br><br> 1-3 days") %}
					{% elif (task_number <= 7 and  task_product == 'Folia') or (task_number <= 9 and task_product == 'Alto') %}
						{% set task_stage = _('PDF Approval') %}
						{% set progress_pourcentage = 50 %}
						{% set progress_color = '#A3A3A3' %}
						{% set project_stage_description = _("Once your file is print ready, we send you a pdf file to approve. The lead time for your project will begin once you have approved the PDF file <br><br><br> 1-3 days") %}
					{% elif task_number >= 12 %}
						{% set task_stage = _('Shipping') %}
						{% set progress_pourcentage = 100 %}
						{% set progress_color = '#629BD0' %}
						{% set project_stage_description = _("We carefully inspect each panel to ensure that your panels conform to our strict quality standards. We then carefully pack you panels so they are shipping on a cloud. <br><br><br> 3-7 days") %}
					{% else %}
						{% set task_stage = _('Production') %}
						{% set progress_pourcentage = 75 %}
						{% set progress_color = '#FCBE38' %}
						{% set project_stage_description = _("Production begins! We will produce beautiful, quality panels for you. <br><br><br> 3-6 weeks") %}
					{% endif %}
	
	
				<!--Deposit dot-->
				<div data-toggle="tooltip" data-placement="top" title="Deposit" class="one" style="background-color: #5cb85c;">
					<span style="text-align: center; margin-top: 11px; margin-left: 12px" class="glyphicon glyphicon-usd" aria-hidden="true"></span>
				</div>
				<!--Preflight dot-->
				<div data-toggle="tooltip" data-placement="top" title="Preflight" class="two" style="background-color: #E78037;">
					<span style="text-align: center; margin-top: 11px; margin-left: 12px" class="glyphicon glyphicon-copy" aria-hidden="true"></span>
				</div>
				<!--PDF Approval dot-->
				<div data-toggle="tooltip" data-placement="top" title="PDF Approval" class="three" style="background-color: #A3A3A3;">
					<span style="text-align: center; margin-top: 11px; margin-left: 14px" class="glyphicon glyphicon-check" aria-hidden="true"></span>
				</div>
				<!--Production dot-->
				<div data-toggle="tooltip" data-placement="top" title="Production" class="four" style="background-color: #FCBE38;">
					<span style="text-align: center; margin-top: 11px; margin-left: 13px" class="glyphicon glyphicon-th-large" aria-hidden="true"></span>
				</div>
				<!--Shipping dot-->
				<div data-toggle="tooltip" data-placement="top" title="Shipping" class="five" style="text-align: center; background-color: #629BD0;">
					<span style="text-align: center; margin-top: 11px;" class="glyphicon glyphicon-plane" aria-hidden="true"></span>
				</div>
				<div class="progress-bar progress-bar-striped active" style="background-color: {{sh_color}} !important; width: {{progress_pourcentage}}%"></div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="row">
		<div class="col-sm-6" style="width: 25%;  ">
			<div id="project_stage_box" style="background-color: {{progress_color}};"><p id="project_stage_label" >{{task_stage}}</p></div>
			<p id="project_stage_description" style="color: {{progress_color}}; border: 2px solid {{progress_color}};">
				{{project_stage_description}}
			</p>
		</div>
		{% set shipping_address = frappe.get_list('Sales Order', filters={'project': doc.name, 'status': ['IN', ['Completed', 'To Bill', 'To Deliver and Bill']]}, fields=['shipping_address', 'shipping_address_name']) %}
		{% if shipping_address[0] %}
			<div class="col-sm-6" style="width: 75%;  ">
				<p>{{_("Shipping Address:")}} <br> <strong>{{shipping_address[0]['shipping_address']}}</strong></p>
				<a href="" class="btn btn-info btn-rounded mb-4" data-toggle="modal" style="background: {{sh_color}};" data-target="#modalLoginForm">
					{{_("Update Shipping Informations")}}
				</a>
				<!-- Only display those informations when the package is at Shipping-->
				{% if task_number >= 12 %}
					<p>{{_("Expected Delivery Date:")}} <strong>{{doc.expected_end_date}}</strong></p>
					<p>{{_("Shipper:")}}
						<a href="{{ frappe.db.get_value('Shipping Company', doc.shipping_company, 'website') }}" target="_blank">
							<strong data-toggle="tooltip" data-placement="top" title="Go to {{doc.shipping_company}} website">{{doc.shipping_company}}</strong>
						</a>
					</p>
					<p>{{_("Tracking Number:") }}
						<strong>
							<a href="{{ frappe.db.get_value('Shipping Company', doc.shipping_company, 'tracking_website') }}" target="_blank">
								<strong data-toggle="tooltip" data-placement="top" title="Track your package">{{doc.waybill}}</strong>
							</a>
						</strong>
					</p>
					<table class="table table-hover" style="width: 75%">
						<thead>
							<caption style="text-align: left;">{{_("Shipment Crates")}}</caption>
							<tr>
								<th scope="col">#</th>
								<th scope="col">{{_("Lenght(in)")}}</th>
								<th scope="col">{{_("Width(in)")}}</th>
								<th scope="col">{{_("Height(in)")}}</th>
								<th scope="col">{{_("Gross Weight(lbs)")}}</th>
								<th scope="col">{{_("Net Weight(lbs)")}}</th>
							</tr>
						</thead>
						<tbody>
						{% for crate in doc.crates %}
							<tr>
								<th scope="row">{{ loop.index }}</th>
								<td>{{ crate.crate_lenght }}</td>
								<td>{{ crate.crate_width }}</td>
								<td>{{ crate.crate_height }}</td>
								<td>{{ crate.crate_gross_weight }}</td>
								<td>{{ crate.crate_net_weight }}</td>
							</tr>
						{% endfor %}
						</tbody>
					</table>
				{% endif %}
			</div>
		{% endif %}
	</div>
	<br> <br>
	<hr />
	
	<div data-widget-host="habitat" id="wt_embed" style="width: 25%;" > 
		<script type="text/props">
		  {
			"wtEmbedKey": "a0124faf-6f51-4fb2-979b-b48552843532",
			"wtEmbedOutput": ".wt_embed_output"
		  }
		</script>
	</div>
	<script async src="https://prod-embed-cdn.wetransfer.net/v1/latest.js"></script>
	<input type="text" name="wt_embed_output" id="wt_embed_output" class="wt_embed_output" hidden/>
	  
	
	<div class='padding'></div>
	<p>{{_("Problem with the link above?")}}</p>
	<a href="https://wetransfer.com/?to={{doc.project_manager}}&msg={{doc.name}}" target="_blank">
		<span class="glyphicon glyphicon-upload" aria-hidden="true"></span>
		<strong data-toggle="tooltip" data-placement="top" title="Transfert your file with WeTransfer">{{_("Click here to transfert your file")}}</strong>
	</a>
	
	{% if doc.attachments %}
		<div class='padding'></div>
		<h4>{{ _("Attachments") }}</h4>
		<div class="project-attachments">
			{% for attachment in doc.attachments %}
				<div class="attachment">
					<a class="no-decoration attachment-link" href="{{ attachment.file_url }}" target="blank">
						<div class="row">
							<div class="col-xs-9">
								<span class="indicator red file-name"> {{ attachment.file_name }}</span>
							</div>
						</div>
					</a>
				</div>
			{% endfor %}
		</div>
	{% endif %}
	
	
	
	
	
	
	
	<!-- Modal to modify shipping address -->
	<div class="modal fade" id="modalLoginForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header text-center" style="background: {{sh_color}};">
					<h4 class="modal-title w-100 font-weight-bold">{{_("Change Shipping Address")}}</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body mx-3">
					<p style="font-style: italic;">
							<strong>Note: </strong>{{ _("The request to change shipping address will be sent to your project manager.  
							This change may incur additional shipping charges; if this is the case,
								your project manager will contact you for your approval.")}}
					</p>
					{% set address_list = frappe.get_list("Dynamic Link", filters={"parenttype": "Address", "link_doctype": "Customer", "link_name": doc.customer}, fields=["parent"]) %}
					<div class="container" id="address_container">
						<div id="accordion">
							{% for a in address_list %}
								{% set address = frappe.get_list("Address", fields=["name", "phone", "country", "pincode", "state", "city", "address_line1", ], filters={"name": a['parent']})[0] %}
								{% if address is defined%}
									{% set address_id = address.name|replace(" ", "_")|replace("(", "")|replace(")", "")|replace("&", "")%}
									<div class="card">
										<div class="card-header">
											<label>
												{% if shipping_address.shipping_address_name == address.name %}
													<input type="radio" class="custom-control-input" name="address" value="{{address.name}}" checked> 
												{% else %}
													<input type="radio" class="custom-control-input" name="address" value="{{address.name}}"> 
												{% endif %}
												<a class="card-link" data-toggle="collapse" href="#{{address_id}}">
													{{address.name}}
												</a>
											</label>
										</div>
										<div id="{{address_id}}" class="collapse " data-parent="#accordion">
											<div class="card-body">
												<div class="container">
													{{address.address_line1}}, {{address.city or ''}}, {{address.state or ''}}, <br> 
													{{address.pincode or ''}}, {{address.country}} <br> 
													{{address.phone or ''}}
												</div>
											</div>
										</div>
									</div>
								{% endif %}
							{% endfor %}
						</div>
						<input type="radio" class="custom-control-input" name="address" value="Other"><label style="font-size: 15px;">{{_("Other")}}</label>
						<br>
						<label id="modal_error_message" style="color: red; font-style: italic;"></label>
					</div>
					<div id="other_address" style="display: none;">   			
						<div class="md-form mb-4">
							<label data-error="wrong" data-success="right" for="address_title">* {{_("Address Title")}}</label>
							<input type="text" id="address_title" class="form-control validate" placeholder="Dorion Shipping">
						</div>
	
						<div class="md-form mb-3">
							<label data-error="wrong" data-success="right" for="address_line_1">* {{_("Address Line 1")}}</label>
							<input type="text" id="address_line_1" class="form-control validate" placeholder="123 ave St-Charles">
						</div>
	
						<div class="md-form mb-3">
							<label data-error="wrong" data-success="right" for="address_city">* {{_("City/Town")}}</label>
							<input type="text" id="address_city" class="form-control validate" placeholder="Dorion">
						</div>
						
						<div class="md-form mb-2">
							<label data-error="wrong" data-success="right" for="address_country">* {{_("Country")}}</label>
							<br>
							
							{% set countries = frappe.get_list('Country', 'name') %}
							<select name="country" class="btn btn-secondary dropdown-toggle">
								{% for country in countries %}
									<option id="address_country" value="{{country.name}}">{{country.name}}</option>
								{% endfor %}
							</select>
						</div>
					</div>
				</div>
				<div class="modal-footer d-flex justify-content-center">
					<button class="btn btn-default" onclick="update_shipping_address()" style="background: {{sh_color}}">{{_("Save and change the shipping address")}}</button>
				</div>
			</div>
		</div>
	</div>
	


<script>
	var rad = document.getElementsByName('address');
	var prev = null;
	for (var i = 0; i < rad.length; i++) {
		rad[i].addEventListener('change', function() {
			(prev) ? console.log(prev.value + "first"): null;
			
			if (this !== prev) {
				prev = this;
			}
			console.log(this.value + "last")
			if (this.value == 'Other'){
				document.getElementById("other_address").style.display = "block";
			}
			else{
				document.getElementById("other_address").style.display = "none";
			}
			//this.style.opacity = "1";
			//rad[i].setAttribute("style", "opacity: 1;");
		});
	}


	function update_shipping_address() {
		document.getElementById("modal_error_message").innerHTML = "";
		address_line_1 = document.getElementById('address_line_1').value;
		address_city = document.getElementById('address_city').value;
		address_country = document.getElementById('address_country').value;
		address_title = document.getElementById('address_title').value;

		if (address_line_1 == null || address_line_1.trim() == "" 
			|| address_city == null || address_city.trim() == ""  
			|| address_country == null || address_country.trim() == ""
			|| address_title == null || address_title.trim() == "")
		{
			document.getElementById("modal_error_message").innerHTML += "Please fill all mandatory fields";
		}
		else{
			document.getElementById("modal_error_message").innerHTML = "";
			console.log("ELSE");
			frappe.call({
				method: "shei.templates.pages.projects.update_shipping_address",
				args: {
					'doc_name': "{{ doc.name }}",
					'customer': "{{ doc.customer }}",
					'address_line_1': address_line_1,
					'address_city': address_city,
					'address_country': address_country,
					'address_title': address_title,
				},
				callback: function(content) {
				}
			});
		}
	}
	function myFunction() {
		if(document.getElementsByClassName('wt_embed__message')[0].getElementsByClassName('main')[0].textContent != 'Upload completed!'){
			setTimeout(myFunction, 500);
		}
		else{
			var wt_output = document.getElementById("wt_embed_output").value;
			frappe.call({
				method: "shei.templates.pages.projects.upload_wetransfer_link",
				args: {
					'doc_name': "{{ doc.name }}",
					'link': wt_output,
				},
				callback: function(content) {
				}
			});
		}
	}
	window.addEventListener("load", myFunction);
</script>
<script>

	{% include "frappe/public/js/frappe/provide.js" %}
	{% include "frappe/public/js/frappe/form/formatters.js" %}
</script>

{% endblock %}
